<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#375EAB">

  <title>analysistest - Go Documentation Server</title>

<link type="text/css" rel="stylesheet" href="/lib/godoc/style.css">

<script>window.initFuncs = [];</script>
<script src="/lib/godoc/jquery.js" defer></script>



<script>var goVersion = "go1.23.0";</script>
<script src="/lib/godoc/godocs.js" defer></script>
</head>
<body>

<div id='lowframe' style="position: fixed; bottom: 0; left: 0; height: 0; width: 100%; border-top: thin solid grey; background-color: white; overflow: auto;">
...
</div><!-- #lowframe -->

<div id="topbar" class="wide"><div class="container">
<div class="top-heading" id="heading-wide"><a href="/pkg/">Go Documentation Server</a></div>
<div class="top-heading" id="heading-narrow"><a href="/pkg/">GoDoc</a></div>
<a href="#" id="menu-button"><span id="menu-button-arrow">&#9661;</span></a>
<form method="GET" action="/search">
<div id="menu">

<span class="search-box"><input type="search" id="search" name="q" placeholder="Search" aria-label="Search" required><button type="submit"><span><!-- magnifying glass: --><svg width="24" height="24" viewBox="0 0 24 24"><title>submit search</title><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/><path d="M0 0h24v24H0z" fill="none"/></svg></span></button></span>
</div>
</form>

</div></div>



<div id="page" class="wide">
<div class="container">


  <h1>
    Package analysistest
    <span class="text-muted"></span>
  </h1>







<div id="nav"></div>


<!--
	Copyright 2009 The Go Authors. All rights reserved.
	Use of this source code is governed by a BSD-style
	license that can be found in the LICENSE file.
-->
<!--
	Note: Static (i.e., not template-generated) href and id
	attributes start with "pkg-" to make it impossible for
	them to conflict with generated attributes (some of which
	correspond to Go identifiers).
-->

	<script>
	document.ANALYSIS_DATA = null;
	document.CALLGRAPH = null;
	</script>

	
		
		<div id="short-nav">
			<dl>
			<dd><code>import "golang.org/x/tools/go/analysis/analysistest"</code></dd>
			</dl>
			<dl>
			<dd><a href="#pkg-overview" class="overviewLink">Overview</a></dd>
			<dd><a href="#pkg-index" class="indexLink">Index</a></dd>
			
			
			</dl>
		</div>
		<!-- The package's Name is printed as title by the top-level template -->
		<div id="pkg-overview" class="toggleVisible">
			<div class="collapsed">
				<h2 class="toggleButton" title="Click to show Overview section">Overview ▹</h2>
			</div>
			<div class="expanded">
				<h2 class="toggleButton" title="Click to hide Overview section">Overview ▾</h2>
				<p>Package analysistest provides utilities for testing analyzers.

				
			</div>
		</div>

		<div id="pkg-index" class="toggleVisible">
		<div class="collapsed">
			<h2 class="toggleButton" title="Click to show Index section">Index ▹</h2>
		</div>
		<div class="expanded">
			<h2 class="toggleButton" title="Click to hide Index section">Index ▾</h2>

		<!-- Table of contents for API; must be named manual-nav to turn off auto nav. -->
			<div id="manual-nav">
			<dl>
			
			
				<dd><a href="#pkg-variables">Variables</a></dd>
			
			
				
				<dd><a href="#WriteFiles">func WriteFiles(filemap map[string]string) (dir string, cleanup func(), err error)</a></dd>
			
			
				
				<dd><a href="#Result">type Result</a></dd>
				
					
					<dd>&nbsp; &nbsp; <a href="#Run">func Run(t Testing, dir string, a *analysis.Analyzer, patterns ...string) []*Result</a></dd>
				
					
					<dd>&nbsp; &nbsp; <a href="#RunWithSuggestedFixes">func RunWithSuggestedFixes(t Testing, dir string, a *analysis.Analyzer, patterns ...string) []*Result</a></dd>
				
				
			
				
				<dd><a href="#Testing">type Testing</a></dd>
				
				
			
			
			</dl>
			</div><!-- #manual-nav -->

		

		
			<h3>Package files</h3>
			<p>
			<span style="font-size:90%">
			
				<a href="/src/golang.org/x/tools/go/analysis/analysistest/analysistest.go">analysistest.go</a>
			
			</span>
			</p>
		
		</div><!-- .expanded -->
		</div><!-- #pkg-index -->

		

		
		
			<h2 id="pkg-variables">Variables</h2>
			
				<p>TestData returns the effective filename of
the program&apos;s &quot;testdata&quot; directory.
This function may be overridden by projects using
an alternative build system (such as Blaze) that
does not run a test in its package directory.

				<pre>var <span id="TestData">TestData</span> = func() <a href="/pkg/builtin/#string">string</a> {
    testdata, err := <a href="/pkg/path/filepath/">filepath</a>.<a href="/pkg/path/filepath/#Abs">Abs</a>(&#34;testdata&#34;)
    if err != <a href="/pkg/builtin/#nil">nil</a> {
        <a href="/pkg/log/">log</a>.<a href="/pkg/log/#Fatal">Fatal</a>(err)
    }
    return testdata
}</pre>
			
		
		
			
			
			<h2 id="WriteFiles">func <a href="/src/golang.org/x/tools/go/analysis/analysistest/analysistest.go?s=904:986#L27">WriteFiles</a>
				<a class="permalink" href="#WriteFiles">&#xb6;</a>
				
				
			</h2>
			<pre>func WriteFiles(filemap map[<a href="/pkg/builtin/#string">string</a>]<a href="/pkg/builtin/#string">string</a>) (dir <a href="/pkg/builtin/#string">string</a>, cleanup func(), err <a href="/pkg/builtin/#error">error</a>)</pre>
			<p>WriteFiles is a helper function that creates a temporary directory
and populates it with a GOPATH-style project using filemap (which
maps file names to contents). On success it returns the name of the
directory and a cleanup function to delete it.

			
			

		
		
			
			
			<h2 id="Result">type <a href="/src/golang.org/x/tools/go/analysis/analysistest/analysistest.go?s=13336:13376#L365">Result</a>
				<a class="permalink" href="#Result">&#xb6;</a>
				
				
			</h2>
			<p>A Result holds the result of applying an analyzer to a package.

			<pre>type Result = <a href="/pkg/golang.org/x/tools/go/analysis/internal/checker/">checker</a>.<a href="/pkg/golang.org/x/tools/go/analysis/internal/checker/#TestAnalyzerResult">TestAnalyzerResult</a></pre>

			

			

			
			
			

			
				
				<h3 id="Run">func <a href="/src/golang.org/x/tools/go/analysis/analysistest/analysistest.go?s=12608:12691#L337">Run</a>
					<a class="permalink" href="#Run">&#xb6;</a>
					
					
				</h3>
				<pre>func Run(t <a href="#Testing">Testing</a>, dir <a href="/pkg/builtin/#string">string</a>, a *<a href="/pkg/golang.org/x/tools/go/analysis/">analysis</a>.<a href="/pkg/golang.org/x/tools/go/analysis/#Analyzer">Analyzer</a>, patterns ...<a href="/pkg/builtin/#string">string</a>) []*<a href="#Result">Result</a></pre>
				<p>Run applies an analysis to the packages denoted by the &quot;go list&quot; patterns.
<p>It loads the packages from the specified
directory using golang.org/x/tools/go/packages, runs the analysis on
them, and checks that each analysis emits the expected diagnostics
and facts specified by the contents of &apos;// want ...&apos; comments in the
package&apos;s source files. It treats a comment of the form
&quot;//...// want...&quot; or &quot;/*...// want... */&quot; as if it starts at &apos;want&apos;.
<p>If the directory contains a go.mod file, Run treats it as the root of the
Go module in which to work. Otherwise, Run treats it as the root of a
GOPATH-style tree, with package contained in the src subdirectory.
<p>An expectation of a Diagnostic is specified by a string literal
containing a regular expression that must match the diagnostic
message. For example:
<pre>fmt.Printf(&quot;%s&quot;, 1) // want `cannot provide int 1 to %s`
</pre>
<p>An expectation of a Fact associated with an object is specified by
&apos;name:&quot;pattern&quot;&apos;, where name is the name of the object, which must be
declared on the same line as the comment, and pattern is a regular
expression that must match the string representation of the fact,
fmt.Sprint(fact). For example:
<pre>func panicf(format string, args interface{}) { // want panicf:&quot;printfWrapper&quot;
</pre>
<p>Package facts are specified by the name &quot;package&quot; and appear on
line 1 of the first source file of the package.
<p>A single &apos;want&apos; comment may contain a mixture of diagnostic and fact
expectations, including multiple facts about the same object:
<pre>// want &quot;diag&quot; &quot;diag2&quot; x:&quot;fact1&quot; x:&quot;fact2&quot; y:&quot;fact3&quot;
</pre>
<p>Unexpected diagnostics and facts, and unmatched expectations, are
reported as errors to the Testing.
<p>Run reports an error to the Testing if loading or analysis failed.
Run also returns a Result for each package for which analysis was
attempted, even if unsuccessful. It is safe for a test to ignore all
the results, but a test may use it to perform additional checks.

				
				
			
				
				<h3 id="RunWithSuggestedFixes">func <a href="/src/golang.org/x/tools/go/analysis/analysistest/analysistest.go?s=4845:4946#L129">RunWithSuggestedFixes</a>
					<a class="permalink" href="#RunWithSuggestedFixes">&#xb6;</a>
					
					
				</h3>
				<pre>func RunWithSuggestedFixes(t <a href="#Testing">Testing</a>, dir <a href="/pkg/builtin/#string">string</a>, a *<a href="/pkg/golang.org/x/tools/go/analysis/">analysis</a>.<a href="/pkg/golang.org/x/tools/go/analysis/#Analyzer">Analyzer</a>, patterns ...<a href="/pkg/builtin/#string">string</a>) []*<a href="#Result">Result</a></pre>
				<p>RunWithSuggestedFixes behaves like Run, but additionally verifies suggested fixes.
It uses golden files placed alongside the source code under analysis:
suggested fixes for code in example.go will be compared against example.go.golden.
<p>Golden files can be formatted in one of two ways: as plain Go source code, or as txtar archives.
In the first case, all suggested fixes will be applied to the original source, which will then be compared against the golden file.
In the second case, suggested fixes will be grouped by their messages, and each set of fixes will be applied and tested separately.
Each section in the archive corresponds to a single message.
<p>A golden file using txtar may look like this:
<pre>-- turn into single negation --
package pkg

func fn(b1, b2 bool) {
	if !b1 { // want `negating a boolean twice`
		println()
	}
}

-- remove double negation --
package pkg

func fn(b1, b2 bool) {
	if b1 { // want `negating a boolean twice`
		println()
	}
}
</pre>
<h3 id="hdr-Conflicts">Conflicts</h3>
<p>A single analysis pass may offer two or more suggested fixes that
(1) conflict but are nonetheless logically composable, (e.g.
because both update the import declaration), or (2) are
fundamentally incompatible (e.g. alternative fixes to the same
statement).
<p>It is up to the driver to decide how to apply such fixes. A
sophisticated driver could attempt to resolve conflicts of the
first kind, but this test driver simply reports the fact of the
conflict with the expectation that the user will split their tests
into nonconflicting parts.
<p>Conflicts of the second kind can be avoided by giving the
alternative fixes different names (SuggestedFix.Message) and
defining the .golden file as a multi-section txtar file with a
named section for each alternative fix, as shown above.
<p>Analyzers that compute fixes from a textual diff of the
before/after file contents (instead of directly from syntax tree
positions) may produce fixes that, although logically
non-conflicting, nonetheless conflict due to the particulars of the
diff algorithm. In such cases it may suffice to introduce
sufficient separation of the statements in the test input so that
the computed diffs do not overlap. If that fails, break the test
into smaller parts.
<p>TODO(adonovan): the behavior of RunWithSuggestedFixes as documented
above is impractical for tests that report multiple diagnostics and
offer multiple alternative fixes for the same diagnostic, and it is
inconsistent with the interpretation of multiple diagnostics
described at Diagnostic.SuggestedFixes.
We need to rethink the analyzer testing API to better support such
cases. In the meantime, users of RunWithSuggestedFixes testing
analyzers that offer alternative fixes are advised to put each fix
in a separate .go file in the testdata.

				
				
			

			
		
			
			
			<h2 id="Testing">type <a href="/src/golang.org/x/tools/go/analysis/analysistest/analysistest.go?s=1834:1904#L59">Testing</a>
				<a class="permalink" href="#Testing">&#xb6;</a>
				
				
			</h2>
			<p>Testing is an abstraction of a *testing.T.

			<pre>type Testing interface {
    Errorf(format <a href="/pkg/builtin/#string">string</a>, args ...interface{})
}</pre>

			

			

			
			
			

			

			
		
	

	







<div id="footer">
Build version go1.23.0.<br>
Except as <a href="https://developers.google.com/site-policies#restrictions">noted</a>,
the content of this page is licensed under the
Creative Commons Attribution 3.0 License,
and code is licensed under a <a href="/LICENSE">BSD license</a>.<br>
<a href="https://golang.org/doc/tos.html">Terms of Service</a> |
<a href="https://www.google.com/intl/en/policies/privacy/">Privacy Policy</a>
</div>

</div><!-- .container -->
</div><!-- #page -->
</body>
</html>
